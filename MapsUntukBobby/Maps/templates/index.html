{% extends "base.html" %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">🚨</div>
        <div class="stat-content">
            <h3 class="stat-number">{{ total_incidents }}</h3>
            <p class="stat-label">Total Kejadian</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">📹</div>
        <div class="stat-content">
            <h3 class="stat-number">{{ total_cctvs }}</h3>
            <p class="stat-label">Total CCTV</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">✅</div>
        <div class="stat-content">
            <h3 class="stat-number">{{ active_cctvs }}</h3>
            <p class="stat-label">CCTV Aktif</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">📈</div>
        <div class="stat-content">
            <h3 class="stat-number" id="weeklyIncidents">-</h3>
            <p class="stat-label">Kejadian Minggu Ini</p>
        </div>
    </div>
</div>

<div class="dashboard-content">
    <!-- Map Section -->
    <div class="map-section">
        <div class="map-header">
            <h2>🗺️ Peta Monitoring Kejadian</h2>
            <div class="map-controls">
                <button id="toggleHeatmap" class="btn btn-sm btn-outline">🔥 Toggle Heatmap</button>
                <button id="toggleCCTV" class="btn btn-sm btn-outline">📹 Toggle CCTV</button>
                <button id="centerMap" class="btn btn-sm btn-outline">🎯 Center Map</button>
                <button id="refreshData" class="btn btn-sm btn-primary">🔄 Refresh</button>
            </div>
        </div>
        <div id="map"></div>

        <!-- Legend -->
        <div class="map-legend">
            <h4>Legenda:</h4>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="legend-heatmap"></span>
                    <span>Area Rawan (Heatmap)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker red"></span>
                    <span>Kejadian</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker blue"></span>
                    <span>CCTV Aktif</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Criteria Statistics -->
        <div class="widget">
            <h3>📊 Statistik Kejadian</h3>
            <div class="criteria-stats">
                {% for criteria, count in criteria_stats.items() %}
                <div class="criteria-item criteria-{{ criteria }}">
                    <span class="criteria-label">{{ criteria.title() }}</span>
                    <span class="criteria-count">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Incidents -->
        <div class="widget">
            <h3>🕒 Kejadian Terbaru</h3>
            <div class="recent-incidents">
                {% if recent_incidents %}
                {% for incident in recent_incidents %}
                <div class="incident-item">
                    <div class="incident-type incident-{{ incident.criteria }}">
                        {{ incident.criteria.title() }}
                    </div>
                    <div class="incident-location">
                        📍 {{ incident.location_name[:50] }}{% if incident.location_name|length > 50 %}...{% endif %}
                    </div>
                    <div class="incident-time">
                        ⏰ {{ incident.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="no-data">Belum ada data kejadian</p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="widget">
            <h3>⚡ Quick Actions</h3>
            <div class="quick-actions">
                <a href="{{ url_for('add_incident_page') }}" class="btn btn-primary btn-block">
                    🚨 Laporkan Kejadian
                </a>
                <a href="{{ url_for('add_cctv_page') }}" class="btn btn-secondary btn-block">
                    📹 Tambah CCTV
                </a>
                <a href="/api/statistics" target="_blank" class="btn btn-outline btn-block">
                    📈 Lihat API Statistik
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Dashboard specific functions
    function loadDashboardStats() {
        fetch('/api/statistics')
            .then(response => response.json())
            .then(data => {
                if (data.recent_incidents !== undefined) {
                    document.getElementById('weeklyIncidents').textContent = data.recent_incidents;
                }
            })
            .catch(error => console.error('Error loading stats:', error));
    }

    // Setup map controls
    function setupMapControls() {
        document.getElementById('toggleHeatmap').addEventListener('click', function () {
            const visible = toggleHeatmap();
            this.textContent = visible ? '🔥 Hide Heatmap' : '🔥 Show Heatmap';
        });

        document.getElementById('toggleCCTV').addEventListener('click', function () {
            const visible = toggleCCTVMarkers();
            this.textContent = visible ? '📹 Hide CCTV' : '📹 Show CCTV';
        });

        document.getElementById('centerMap').addEventListener('click', function () {
            if (window.map) {
                map.setView([-6.2088, 106.8456], 13);
            }
        });

        document.getElementById('refreshData').addEventListener('click', function () {
            refreshAllMapData();
            loadDashboardStats();

            // Visual feedback
            this.innerHTML = '⏳ Refreshing...';
            setTimeout(() => {
                this.innerHTML = '🔄 Refresh';
            }, 2000);
        });
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        loadDashboardStats();

        // Setup controls after map is loaded
        setTimeout(setupMapControls, 1000);
    });
</script>
{% endblock %}